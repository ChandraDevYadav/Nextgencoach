import Transcript from "../models/Transcript.Model.js";
import { OpenAI } from "openai";

const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

export const analyzePreQuestions = async (req, res) => {
  const { clientResponses, zoomId } = req.body;

  if (!clientResponses || !zoomId) {
    return res
      .status(400)
      .json({ message: "clientResponses and zoomId are required." });
  }

  try {
    const systemPrompt = `‚ö†Ô∏è Important Notice: AI-Generated Reflective Output\n\nDisclosure Version: IR-AI-2025-v3.7\n\nBy generating or viewing this content, you acknowledge and accept that it is speculative, incomplete, and intended solely for internal personal reflection or coaching preparation.\n\nThis output was produced by an artificial intelligence system developed and operated by Industry Rockstar, with support from internal and external contributors. These contributors are referenced only for transparency and are not liable for any decisions, outcomes, or interpretations related to this content.\n\nThis system is designed to support soft-skill development, coaching conversations, and personal reflection. It is not a substitute for professional advice in any medical, financial, legal, or employment context.\n\n‚ùå This output is NOT:\n- A diagnosis, therapy method, or psychological evaluation\n- A financial plan, tax strategy, or investment recommendation\n- A legal opinion, contract analysis, or hiring assessment\n- A substitute for certified advice or regulated professional authority\n\nAll references to emotional, mental, or belief-based themes are metaphorical and speculative. This output is not based on DSM-5, ICD, CBT, or any clinical methodology and does not simulate or impersonate any real person or professional authority.\n\nThis tool may be accessed by users with or without formal credentials. Industry Rockstar and its collaborators cannot monitor, endorse, or control how this content is used once generated ‚Äî and disclaim all liability associated with its use or misuse.\n\nüö´ You must not use this content to:\n- Diagnose, treat, evaluate, or profile anyone\n- Determine eligibility for hiring, rejection, partnership, or program inclusion\n- Embed into automated decision systems related to employment, safety, legal risk, or finances\n- Offer or act on legal, medical, investment, or safety-related advice\n- Share externally without the full, attached disclaimer\n\n‚úÖ By continuing, you agree to:\n- Take full responsibility for any use, sharing, or outcome based on this content\n- Not present this output as official advice, certified analysis, or definitive judgment\n- Seek licensed professional guidance before applying content to high-stakes situations\n\nMisuse or misrepresentation of this output is solely the responsibility of the user and may result in legal, ethical, or reputational consequences.\n\n---\n\nYou are a composite coaching intelligence assistant trained in the integrated methodologies of:\n- Andy Bustamante\n- Dan Sullivan\n- Carl Buchheit\n- Jordan Peterson\n- Kane Minkus\n- Ryan Reynolds\n- Timeless Wisdom Insight\n\nYour job is to analyze a client‚Äôs intake responses and reflect 7 insightful, emotionally intelligent questions that may further illuminate inner patterns, without using clinical or diagnostic language.`;

    const customPrompt = `Generate 7 deep, emotionally intelligent intake questions for a client before their first session. The questions should gently surface internal conflicts, hidden motivations, identity patterns, and belief structures ‚Äî without being clinical or hard to answer.\n\nDo not mention therapy, psychology, or any named methodology. Do not explain your reasoning. Return only the questions ‚Äî followed by the full bottom disclaimer.\n\nClient‚Äôs Pre-Answers:\n${clientResponses}`;

    const bottomDisclaimer = `\n\nDisclosure Version: IR-AI-2025-v3.7\n\nThis content was generated by an artificial intelligence system operated by Industry Rockstar, with support from independent contributors. These contributors are referenced only for operational transparency and are not responsible or liable for any interpretations, applications, or consequences resulting from this content.\n\nThis output is entirely speculative and intended only for reflection. It may include metaphorical framing or emotional language that is not diagnostic, legal, financial, or evaluative in nature.\n\n‚ùå This content is not:\n- A substitute for therapy, financial advising, legal review, or professional consultation\n- A certified psychological evaluation or treatment recommendation\n- A hiring tool, eligibility screen, or access control mechanism\n- A simulation or impersonation of any person, clinician, attorney, or financial advisor\n\nThis content must not be embedded in automation, hiring software, legal workflows, or financial decision systems.\n\nüö´ Do not use this content to:\n- Make decisions about diagnosis, health, employment, contracts, or safety\n- Offer or act on investment, legal, or therapeutic advice\n- Determine eligibility, approval, rejection, or categorization of any person\n- Share this content externally without the full disclaimer and version stamp\n\n‚úÖ By using this system, you confirm that:\n- You assume full responsibility for how this content is interpreted, shared, or applied\n- You understand this content is not definitive advice, and not covered under professional licensing standards\n- You release Industry Rockstar and all related entities from liability for its use\n\nIf you are unsure how to interpret this output, pause and consult a qualified expert.\n\nGenerated under:\n**Version ID:** IR-AI-2025-v3.7\n**Classification:** Reflective AI Output (Non-Evaluative)\n**Status:** Not for External Distribution Without Full Disclaimer`;

    const fullPrompt = `${systemPrompt}\n\n${customPrompt}`;

    const completion = await openai.chat.completions.create({
      model: "gpt-4o",
      messages: [
        { role: "system", content: systemPrompt },
        { role: "user", content: customPrompt },
      ],
      temperature: 0.7,
      max_tokens: 1200,
    });

    const result = completion.choices[0].message.content + bottomDisclaimer;

    await Transcript.findOneAndUpdate(
      { zoomId },
      { preQuestionAnalysis: result },
      { new: true, upsert: true }
    );

    res.status(200).json({ analysis: result });
  } catch (err) {
    console.error("OpenAI error:", err);
    res
      .status(500)
      .json({ message: "AI processing failed", error: err.message });
  }
};
